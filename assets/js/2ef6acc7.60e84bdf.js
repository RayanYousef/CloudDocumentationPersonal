"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[538],{5964(e,n,i){i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"reference/scripts","title":"Scripts Reference","description":"This section contains the reference for the scripts used in the Unity Cloud Build pipeline. You can view the code below or download the files.","source":"@site/docs/reference/scripts.md","sourceDirName":"reference","slug":"/reference/scripts","permalink":"/CloudDocumentationPersonal/reference/scripts","draft":false,"unlisted":false,"editUrl":"https://github.com/RayanYousef/CloudDocumentationPersonal/edit/main/website/docs/reference/scripts.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Unity CI Build Issue: IDE Package Certificate CRL Error - Solution Guide","permalink":"/CloudDocumentationPersonal/troubleshooting/Unity_IDE_Package_Removal_Solution"},"next":{"title":"Workflows Reference","permalink":"/CloudDocumentationPersonal/reference/workflows"}}');var r=i(4848),o=i(8453);const s={},a="Scripts Reference",l={},c=[{value:"CustomBuildProcessor.cs",id:"custombuildprocessorcs",level:2},{value:"IOSCodeSigningProcessor.cs",id:"ioscodesigningprocessorcs",level:2},{value:"VersionInfo.cs",id:"versioninfocs",level:2},{value:"VersionText.cs",id:"versiontextcs",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"scripts-reference",children:"Scripts Reference"})}),"\n",(0,r.jsx)(n.p,{children:"This section contains the reference for the scripts used in the Unity Cloud Build pipeline. You can view the code below or download the files."}),"\n",(0,r.jsx)(n.h2,{id:"custombuildprocessorcs",children:"CustomBuildProcessor.cs"}),"\n",(0,r.jsx)(n.p,{children:"Handles the build process customizations."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"/CloudDocumentationPersonal/downloads/scripts/CustomBuildProcessor.cs",children:"Download CustomBuildProcessor.cs"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'using System;\nusing System.IO;\nusing UnityEditor;\nusing UnityEditor.Build;\nusing UnityEditor.Build.Reporting;\nusing UnityEngine;\n#if UNITY_IOS\nusing UnityEditor.iOS.Xcode;\n#endif\n\n/// <summary>\n/// Used mainly for cloud build\n/// Auto incremeant android and ios per build\n/// </summary>\ninternal class CustomBuildProcessor : IPreprocessBuildWithReport, IPostprocessBuildWithReport\n{\n    //Text file next to the asset and libary folders\n    private const string fileName = "VersioningSettings.json";\n    private CloudBuildData cloudBuildData;\n    private string path;\n    const string Android_keystorePw = "d9y#Kk22D%@U52";\n    const string Android_aliasPw = "d9y#Kk22D%@U52";\n\n    [System.Serializable]\n    private struct CloudBuildData\n    {\n        public string AppVersion;\n        public int BuildVersionAndroid;\n        public int BuildNumberIOS;\n        public bool AutoIncremeantVersionNumber;\n        public bool AutoIncremeantAndroid;\n        public bool AutoIncremeantIOS;\n        public string BuildBranch;\n    }\n\n\n\n    public int callbackOrder\n    { get { return 0; } }\n\n    public void OnPostprocessBuild(BuildReport report)\n    {\n        GetFilePath();\n        string buildInfo = "Build Ended With result : " + report.summary.result + "\\\\n";\n        buildInfo += "Build size : " + report.summary.totalSize;\n#if UNITY_IOS\n        IOSPlistUpdate(report.summary.outputPath);\n#endif\n    }\n\n    public void OnPreprocessBuild(BuildReport report)\n    {\n        GetFilePath();\n        ReadJsonData();\n        SetupProjectSetting();\n        CreateVersionInfoFile(report.summary.platform);\n        SaveUpdatedData();\n\n        Debug.Log("MyCustomBuildProcessor.OnPreprocessBuild for target " + report.summary.platform + " at path " + report.summary.outputPath);\n    }\n\n    private void GetFilePath()\n    {\n        // Build absolute path to repo-root/CloudBuild/VersioningSettings.json\n        string assetsPath = Application.dataPath;\n        string projectRoot = Directory.GetParent(assetsPath).FullName; // SkrewClient\n        string repoRoot = Directory.GetParent(projectRoot).FullName;    // repo root\n        path = Path.Combine(repoRoot, "CloudBuild", fileName);\n    }\n\n    private void ReadJsonData()\n    {\n        string text = File.ReadAllText(path);\n        cloudBuildData = JsonUtility.FromJson<CloudBuildData>(text);\n    }\n\n    private void SetupProjectSetting()\n    {\n        PlayerSettings.bundleVersion = cloudBuildData.AppVersion;\n        PlayerSettings.Android.bundleVersionCode = cloudBuildData.BuildVersionAndroid;\n        PlayerSettings.iOS.buildNumber = cloudBuildData.BuildNumberIOS.ToString();\n\n        //Assigning Keystore pw\n        PlayerSettings.Android.keystorePass = Android_keystorePw;\n        PlayerSettings.Android.keyaliasPass = Android_aliasPw;\n    }\n\n    private void CreateVersionInfoFile(BuildTarget buildTarget)\n    {\n        // Create Resources folder if it doesn\'t exist\n        string resourcesPath = Path.Combine(Application.dataPath, "Resources");\n        if (!Directory.Exists(resourcesPath))\n        {\n            Directory.CreateDirectory(resourcesPath);\n        }\n\n        // Create version info based on platform\n        VersionInfo versionInfo = new VersionInfo\n        {\n            versionNumber = cloudBuildData.AppVersion,\n            buildTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")\n        };\n\n        if (buildTarget == BuildTarget.Android)\n        {\n            versionInfo.buildVersion = cloudBuildData.BuildVersionAndroid;\n            versionInfo.platform = "Android";\n        }\n        else if (buildTarget == BuildTarget.iOS)\n        {\n            versionInfo.buildVersion = cloudBuildData.BuildNumberIOS;\n            versionInfo.platform = "iOS";\n        }\n        else\n        {\n            versionInfo.buildVersion = 0;\n            versionInfo.platform = buildTarget.ToString();\n        }\n\n        // Save to Resources folder as JSON\n        string json = JsonUtility.ToJson(versionInfo, true);\n        string versionFilePath = Path.Combine(resourcesPath, "version_info.txt");\n        File.WriteAllText(versionFilePath, json);\n\n        Debug.Log($"Created version info file: {versionInfo.platform} v{versionInfo.versionNumber} ({versionInfo.buildVersion})");\n\n        // Refresh the AssetDatabase to ensure Unity recognizes the new file\n        AssetDatabase.Refresh();\n    }\n\n    private void SaveUpdatedData()\n    {\n        //save the data in case we need to adjust it manually\n        string text = JsonUtility.ToJson(cloudBuildData, true);\n        File.WriteAllText(path, text);\n    }\n#if UNITY_IOS\n    private void IOSPlistUpdate(string pPath)\n    {\nstring plistPath = pPath + "/Info.plist";\n        PlistDocument plist = new PlistDocument();\n        plist.ReadFromString(File.ReadAllText(plistPath));\n\n        // Get root\n        PlistElementDict rootDict = plist.root;\n\n        // Add key with value\n        rootDict.SetBoolean("ITSAppUsesNonExemptEncryption", false);\n\n        // Write to file\n        File.WriteAllText(plistPath, plist.WriteToString());\n    }\n#endif\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"ioscodesigningprocessorcs",children:"IOSCodeSigningProcessor.cs"}),"\n",(0,r.jsx)(n.p,{children:"Handles iOS code signing and entitlements."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"/CloudDocumentationPersonal/downloads/scripts/IOSCodeSigningProcessor.cs",children:"Download IOSCodeSigningProcessor.cs"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'using System;\nusing System.IO;\nusing System.Xml;\nusing UnityEditor;\nusing UnityEditor.Build;\nusing UnityEditor.Build.Reporting;\nusing UnityEngine;\n#if UNITY_IOS\nusing UnityEditor.iOS.Xcode;\n#endif\n\n/// <summary>\n/// iOS Code Signing Processor for Unity Builds\n///\n/// This script automatically configures code signing for iOS notification service extensions.\n/// IMPORTANT: Before using this script, you MUST update the placeholder values below with your actual:\n/// - Apple Developer Team ID\n/// - Provisioning Profile UUID\n/// - Apple Distribution Certificate details\n///\n/// Find these values in your Apple Developer Console and update the TODO sections.\n/// </summary>\ninternal class IOSCodeSigningProcessor : IPostprocessBuildWithReport\n{\n    public int callbackOrder => 1;\n\n    public void OnPostprocessBuild(BuildReport report)\n    {\n#if UNITY_IOS\n        if (report.summary.platform == BuildTarget.iOS)\n        {\n            try\n            {\n                ConfigureIOSCodeSigning(report.summary.outputPath);\n            }\n            catch (Exception ex)\n            {\n                string errorMessage = $"iOS Code Signing configuration failed: {ex.Message}";\n                Debug.LogError(errorMessage);\n                throw new BuildFailedException(errorMessage);\n            }\n        }\n#endif\n    }\n\n#if UNITY_IOS\n    private void ConfigureIOSCodeSigning(string buildPath)\n    {\n        string projectPath = buildPath + "/Unity-iPhone.xcodeproj/project.pbxproj";\n\n        if (!File.Exists(projectPath))\n        {\n            string errorMessage = "Xcode project file not found at: " + projectPath;\n            Debug.LogError(errorMessage);\n            throw new BuildFailedException(errorMessage);\n        }\n\n        PBXProject project = new PBXProject();\n        project.ReadFromFile(projectPath);\n\n        string mainTargetGuid = project.GetUnityMainTargetGuid();\n\n        string bundleIdentifierForNotificationService = Application.identifier + ".notificationservice";\n        int indexOfLastIdentifierSection = bundleIdentifierForNotificationService.LastIndexOf(\'.\') + 1;\n        string targetName = bundleIdentifierForNotificationService.Substring(indexOfLastIdentifierSection);\n\n        string notificationServiceTargetGuid = project.TargetGuidByName(targetName);\n\n        if (notificationServiceTargetGuid == null)\n        {\n\n            notificationServiceTargetGuid = project.TargetGuidByName("notificationservice");\n            if (notificationServiceTargetGuid != null)\n            {\n                targetName = "notificationservice";\n            }\n            else\n            {\n                notificationServiceTargetGuid = project.TargetGuidByName("NotificationService");\n                if (notificationServiceTargetGuid != null)\n                {\n                    targetName = "NotificationService";\n                }\n            }\n        }\n\n        if (notificationServiceTargetGuid == null)\n        {\n            string errorMessage = "Notification service target not found. Please check the target name in Xcode or add it manually.";\n            Debug.LogError(errorMessage);\n            throw new BuildFailedException(errorMessage);\n        }\n\n        if (notificationServiceTargetGuid != null)\n        {\n            // Configure code signing for notification service extension\n            project.SetBuildProperty(notificationServiceTargetGuid, "CODE_SIGN_STYLE", "Manual");\n\n            // TODO: Replace with your actual provisioning profile UUID from Apple Developer Console\n            project.SetBuildProperty(notificationServiceTargetGuid, "PROVISIONING_PROFILE_SPECIFIER", "YOUR_PROVISIONING_PROFILE_UUID");\n\n            // TODO: Replace with your Apple Developer Team ID\n            project.SetBuildProperty(notificationServiceTargetGuid, "DEVELOPMENT_TEAM", "YOUR_TEAM_ID");\n\n            // TODO: Replace with your Apple Distribution certificate name (format: "Apple Distribution: Your Name (TEAM_ID)")\n            project.SetBuildProperty(notificationServiceTargetGuid, "CODE_SIGN_IDENTITY", "Apple Distribution: Your Name (YOUR_TEAM_ID)");\n\n            project.SetBuildProperty(notificationServiceTargetGuid, "INFOPLIST_FILE", $"{targetName}/Info.plist");\n\n            string notificationServicePath = Path.Combine(buildPath, targetName);\n            string notificationServiceM = Path.Combine(notificationServicePath, "NotificationService.m");\n            string notificationServiceH = Path.Combine(notificationServicePath, "NotificationService.h");\n            string infoPList = Path.Combine(notificationServicePath, "Info.plist");\n            string skrewEntitlements = Path.Combine(buildPath, "skrew.entitlements");\n\n            ValidateRequiredPath(notificationServicePath, "Notification service directory", true);\n            ValidateRequiredPath(notificationServiceM, "NotificationService.m");\n            ValidateRequiredPath(notificationServiceH, "NotificationService.h");\n            ValidateRequiredPath(infoPList, "Info.plist");\n            ValidateRequiredPath(skrewEntitlements, "skrew.entitlements");\n\n            string buildPhaseId = project.GetSourcesBuildPhaseByTarget(notificationServiceTargetGuid);\n            if (string.IsNullOrEmpty(buildPhaseId))\n            {\n                buildPhaseId = project.AddSourcesBuildPhase(notificationServiceTargetGuid);\n            }\n\n            string mFileGuid = AddFileToProject(project, targetName, "NotificationService.m");\n            string hFileGuid = AddFileToProject(project, targetName, "NotificationService.h");\n            string infoPlistGuid = AddFileToProject(project, targetName, "Info.plist");\n            string skrewEntitlementsGuid = AddFileToProject(project, "", "skrew.entitlements");\n\n            if (!string.IsNullOrEmpty(mFileGuid) && !string.IsNullOrEmpty(buildPhaseId))\n            {\n                project.AddFileToBuildSection(notificationServiceTargetGuid, buildPhaseId, mFileGuid);\n            }\n\n            project.AddTargetDependency(mainTargetGuid, notificationServiceTargetGuid);\n            UpdateXcodeScheme(buildPath, targetName, notificationServiceTargetGuid);\n        }\n\n        try\n        {\n            project.WriteToFile(projectPath);\n        }\n        catch (Exception ex)\n        {\n            string errorMessage = $"Failed to write Xcode project file: {ex.Message}";\n            Debug.LogError(errorMessage);\n            throw new BuildFailedException(errorMessage);\n        }\n    }\n\n    private void ValidateRequiredPath(string path, string description, bool isDirectory = false)\n    {\n        bool exists = isDirectory ? Directory.Exists(path) : File.Exists(path);\n        if (!exists)\n        {\n            string errorMessage = $"Required {(isDirectory ? "directory" : "file")} not found: {description} at {path}";\n            Debug.LogError(errorMessage);\n            throw new BuildFailedException(errorMessage);\n        }\n    }\n\n    private void UpdateXcodeScheme(string buildPath,string targetName, string notificationServiceTargetGuid)\n    {\n        string schemePath = buildPath + "/Unity-iPhone.xcodeproj/xcshareddata/xcschemes/Unity-iPhone.xcscheme";\n        if (!File.Exists(schemePath))\n            return;\n\n        XmlDocument schemeDoc = new XmlDocument();\n        schemeDoc.Load(schemePath);\n\n        XmlNode buildActionNode = schemeDoc.SelectSingleNode("//BuildAction");\n        if (buildActionNode != null)\n        {\n            XmlNode buildActionEntriesNode = buildActionNode.SelectSingleNode("BuildActionEntries");\n            if (buildActionEntriesNode != null)\n            {\n                bool included = false;\n                XmlNodeList existingEntries = buildActionEntriesNode.SelectNodes("BuildActionEntry/BuildableReference[@BlueprintName=\'" + targetName + "\']");\n                if (existingEntries.Count > 0)\n                {\n                    included = true;\n                }\n\n                if (!included)\n                {\n                    XmlElement newBuildActionEntry = schemeDoc.CreateElement("BuildActionEntry");\n                    newBuildActionEntry.SetAttribute("buildForTesting", "YES");\n                    newBuildActionEntry.SetAttribute("buildForRunning", "YES");\n                    newBuildActionEntry.SetAttribute("buildForProfiling", "YES");\n                    newBuildActionEntry.SetAttribute("buildForArchiving", "YES");\n                    newBuildActionEntry.SetAttribute("buildForAnalyzing", "YES");\n\n                    XmlElement buildableReference = schemeDoc.CreateElement("BuildableReference");\n                    buildableReference.SetAttribute("BuildableIdentifier", "primary");\n                    buildableReference.SetAttribute("BlueprintIdentifier", notificationServiceTargetGuid);\n                    buildableReference.SetAttribute("BuildableName", targetName + ".appex");\n                    buildableReference.SetAttribute("BlueprintName", targetName);\n                    buildableReference.SetAttribute("ReferencedContainer", "container:Unity-iPhone.xcodeproj");\n\n                    newBuildActionEntry.AppendChild(buildableReference);\n                    buildActionEntriesNode.AppendChild(newBuildActionEntry);\n                }\n            }\n        }\n\n        schemeDoc.Save(schemePath);\n    }\n\n    private string AddFileToProject(PBXProject project, string targetName, string fileName)\n    {\n        string projectPath = Path.Combine(targetName, fileName);\n        string fileGuid = project.FindFileGuidByProjectPath(projectPath);\n        if (!string.IsNullOrEmpty(fileGuid))\n        {\n            project.RemoveFile(fileGuid);\n        }\n        return project.AddFile(projectPath, projectPath, PBXSourceTree.Source);\n    }\n#endif\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"versioninfocs",children:"VersionInfo.cs"}),"\n",(0,r.jsx)(n.p,{children:"Defines the structure for version information."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"/CloudDocumentationPersonal/downloads/scripts/VersionInfo.cs",children:"Download VersionInfo.cs"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"/// <summary>\n/// Shared version information structure for build-time and runtime use\n/// </summary>\n[System.Serializable]\npublic struct VersionInfo\n{\n    public string versionNumber;\n    public int buildVersion;\n    public string platform;\n    public string buildTime;\n}\n\n"})}),"\n",(0,r.jsx)(n.h2,{id:"versiontextcs",children:"VersionText.cs"}),"\n",(0,r.jsx)(n.p,{children:"Displays the version information in the UI."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"/CloudDocumentationPersonal/downloads/scripts/VersionText.cs",children:"Download VersionText.cs"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'using UnityEngine;\nusing TMPro;\n\npublic class VersionText : MonoBehaviour\n{\n    [SerializeField] TextMeshProUGUI txt_version;\n\n    // Start is called once before the first execution of Update after the MonoBehaviour is created\n    void Start()\n    {\n        SetVersionTexts();\n    }\n\n    private void SetVersionTexts()\n    {\n        try\n        {\n            // Try to load version info from Resources\n            TextAsset versionAsset = Resources.Load<TextAsset>("version_info");\n            if (versionAsset != null)\n            {\n                VersionInfo versionInfo = JsonUtility.FromJson<VersionInfo>(versionAsset.text);\n                txt_version.text = $"v{versionInfo.versionNumber}_bv{versionInfo.buildVersion}";\n                return;\n            }\n        }\n        catch (System.Exception e)\n        {\n            Debug.LogWarning($"Failed to load version info: {e.Message}");\n        }\n\n        // Fallback to Application.version if version_info.txt is not available\n        Debug.Log("Using fallback version from Application.version");\n        txt_version.text = $"v{Application.version}";\n    }\n\n\n}\n\n'})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,i){i.d(n,{R:()=>s,x:()=>a});var t=i(6540);const r={},o=t.createContext(r);function s(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);